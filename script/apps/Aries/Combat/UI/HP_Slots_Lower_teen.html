<!-- "script/apps/Aries/Combat/UI/HP_Slots_Lower_teen.html" -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Homeland store, by Andy, 2009/6/12</title>
</head> 
<body>
<pe:mcml>
<script type="text/npl" src="HP_Slots_Lower.lua" refresh="true"><![CDATA[
local pageCtrl = document:GetPageCtrl();
local LOG = LOG;

local ItemManager = System.Item.ItemManager;
local hasGSItem = ItemManager.IfOwnGSItem;
local equipGSItem = ItemManager.IfEquipGSItem;

local Combat = commonlib.gettable("MyCompany.Aries.Combat");

local ObjectManager = commonlib.gettable("MyCompany.Aries.Combat.ObjectManager");
local ProfileManager = commonlib.gettable("Map3DSystem.App.profiles.ProfileManager");

local class = pageCtrl:GetRequestParam("class");
local subclass = pageCtrl:GetRequestParam("subclass");
pageCtrl:SetNodeValue("class", class);
pageCtrl:SetNodeValue("subclass", subclass);

isInTutorial = false;
local IsInTutorial = commonlib.getfield("MyCompany.Aries.Quest.NPCs.BasicArena.IsInTutorial");
if(IsInTutorial) then
	if(IsInTutorial()) then
		isInTutorial = true;
	end
end

isAB_SDK = false;
if(System.options.isAB_SDK)then
    isAB_SDK = true;
end

local petlevel={};
data = {};
local GetMyArenaData = commonlib.getfield("MyCompany.Aries.Combat.MsgHandler.GetMyArenaData");
if(GetMyArenaData) then
    data = GetMyArenaData();
end

bMyArenaPlayingTurns = false;
local IsMyArenaPlayingTurns = commonlib.getfield("MyCompany.Aries.Combat.MsgHandler.IsMyArenaPlayingTurns");
if(IsMyArenaPlayingTurns) then
    bMyArenaPlayingTurns = IsMyArenaPlayingTurns();
end

data_pickedcards = {};
local GetMyArenaPickedCards = commonlib.getfield("MyCompany.Aries.Combat.MsgHandler.GetMyArenaPickedCards");
if(GetMyArenaPickedCards) then
    data_pickedcards = GetMyArenaPickedCards();
end

bMyselfFarSideInArena = data.bMyselfFarSideInArena;

local buffline = function(icon_or_gsid, desc, count)

if(type(icon_or_gsid) == "number" and desc) then
    local gsItem = ItemManager.GetGlobalStoreItemInMemory(icon_or_gsid);
    if(gsItem and gsItem.descfile) then
        if(not gsItem.template.stats[221] or gsItem.template.stats[221] == 0) then
            icon_or_gsid = gsItem.descfile;
        end
    end
end

if(type(icon_or_gsid) == "number") then
    local tooltip_str = "";
    if(desc) then
        tooltip_str = string.format([[tooltip="%s"]], desc);
    end
    return string.format([[
        <div style="float:left;width:20px;height:20px;margin:1px;">
            <pe:item gsid='%d' isclickable="false" style="width:20px;height:20px;" %s/>
            <div style="position:relative;margin-left:4px;margin-top:-16px;width:20px;text-shadow:true;color:#ffffff;font-size:12px;text-align:center;">%s</div>
        </div>
    ]], icon_or_gsid, tooltip_str, if_else(count and count > 1, tostring(count), ""));
else
    return string.format([[
        <div style="float:left;width:20px;height:20px;margin:1px;">
            <img src='%s' style="width:20px;height:20px;" tooltip="%s"/>
            <div style="position:relative;margin-left:4px;margin-top:-16px;width:20px;text-shadow:true;color:#ffffff;font-size:12px;text-align:center;">%s</div>
        </div>
    ]], icon_or_gsid, desc, if_else(count and count > 1, tostring(count), ""));
end

end

local buff_data = ObjectManager.CreateGetCharmAndWardData();

function DS_Func_Players(index)
    if(index == nil) then
        return 4;
    else
        index=5-index;
        if(bMyselfFarSideInArena == true) then
            index = index + 4;
        end
        if(data.players[index]) then
            local player = commonlib.deepcopy(data.players[index]);
            if(not player.nid) then
                player.isEmpty = true;
                player.school_symbol = "";
            else
                player.isEmpty = false;
                if(isInTutorial) then
                    player.school_symbol = "";
                else
                    player.school_symbol = "Texture/Aries/Team/"..player.phase.."_32bits.png";
                end
            end
            if(bMyselfFarSideInArena) then
                player.slot_symbol = "Texture/Aries/Combat/CombatStateTeen/PosIcon"..(13-index).."_32bits.png";
                player.slot_symbol_small = "Texture/Aries/Combat/CombatStateTeen/PosIcon"..(13-index).."_small_32bits.png";
            else
                player.slot_symbol = "Texture/Aries/Combat/CombatStateTeen/PosIcon"..(5-index).."_32bits.png";
                player.slot_symbol_small = "Texture/Aries/Combat/CombatStateTeen/PosIcon"..(5-index).."_small_32bits.png";
            end
            
            player.slot_symbol = "";
            player.slot_symbol_small = "";

            local fled_helper_slot = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosFled_32bits.png' style="margin:2px;width:20px;height:20px;"/>]];
            local empty_helper_slot = [[<img src='' style="margin:2px;width:20px;height:20px;"/>]];
            local pass_helper_slot = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosPass_32bits.png' style="margin:2px;width:20px;height:20px;"/>]];
            local dead_helper_slot = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosDead_32bits.png' style="margin:2px;width:20px;height:20px;"/>]];

            player.pick_card_helper_slot1 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon4_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot2 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon3_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot3 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon2_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot4 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon1_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot5 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon8_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot6 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon7_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot7 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon6_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];
            player.pick_card_helper_slot8 = [[<img src='Texture/Aries/Combat/CombatStateTeen/PosIcon5_32bits.png' style="background-color:#338ba4;margin:2px;width:20px;height:20px;"/>]];

            -- lower units
            local _;
            for _ = 1, 4 do
                if(data.players[_] and data.players[_].current_hp == 0) then
                    player["pick_card_helper_slot".._] = dead_helper_slot;
                elseif(data.fledslots[_]) then
                    player["pick_card_helper_slot".._] = fled_helper_slot;
                elseif(not (data.players[_] and data.players[_].slot_id)) then
                    player["pick_card_helper_slot".._] = empty_helper_slot;
                end
            end
            -- upper units
            local _;
            for _ = 5, 8 do
                if((data.players[_] and data.players[_].current_hp == 0) or (data.mobs[_ - 4] and data.mobs[_ - 4].current_hp == 0)) then
                    player["pick_card_helper_slot".._] = dead_helper_slot;
                elseif(data.fledslots[_]) then
                    player["pick_card_helper_slot".._] = fled_helper_slot;
                elseif(not (data.players[_] and data.players[_].slot_id)) then
                    if(not (data.mobs[_ - 4] and data.mobs[_ - 4].slot_id)) then
                        player["pick_card_helper_slot".._] = empty_helper_slot;
                    end
                end
            end

            player.isAutoAICard = false;

            if(data_pickedcards[index]) then
                player.haspicked = true;
                player.key = data_pickedcards[index].key;
                player.isAutoAICard = data_pickedcards[index].isAutoAICard;
                player.card_bg = "";
                player.petlevel = 0;
                player.target_icon = "";

                -- traverse through all cardsww
                local gsid;
                local tmp;
                
                local gsid = Combat.Get_gsid_from_cardkey(player.key);
                if(not gsid) then
                    gsid = Combat.Get_gsid_from_rune_cardkey(player.key);
                end
                if(gsid) then
		            local gsItem = ItemManager.GetGlobalStoreItemInMemory(gsid);
		            if(gsItem) then
                        player.card_bg = gsItem.icon;

                        local s = string.format("%s;0 0 44 44", gsItem.descfile or "");
                        player.target_icon = s;

                        player.target_gsid = gsid;
                    end
                end

                if(gsid) then
                    if(data_pickedcards[index].target_slotid and data_pickedcards[index].target_slotid > 0) then
                        local target_slotid = data_pickedcards[index].target_slotid;
                        player["pick_card_helper_slot"..target_slotid] = [[<pe:item gsid=']]..player.target_gsid..[[' style="margin:2px;width:20px;height:20px;" isclickable="false"/>]];
                    elseif(data_pickedcards[index].target_slotid and data_pickedcards[index].target_slotid == -1) then
                        local _;
                        for _ = 1, 4 do
                            if(player["pick_card_helper_slot".._] ~= fled_helper_slot and player["pick_card_helper_slot".._] ~= empty_helper_slot) then
                                player["pick_card_helper_slot".._] = [[<pe:item gsid=']]..player.target_gsid..[[' style="margin:2px;width:20px;height:20px;" isclickable="false"/>]];
                            end
                        end
                    elseif(data_pickedcards[index].target_slotid and data_pickedcards[index].target_slotid == -2) then
                        local _;
                        for _ = 5, 8 do
                            if(player["pick_card_helper_slot".._] ~= fled_helper_slot and player["pick_card_helper_slot".._] ~= empty_helper_slot) then
                                player["pick_card_helper_slot".._] = [[<pe:item gsid=']]..player.target_gsid..[[' style="margin:2px;width:20px;height:20px;" isclickable="false"/>]];
                            end
                        end
                    end
                elseif(player.key == "Pass") then
                    if(player.slot_id) then
                        player["pick_card_helper_slot"..player.slot_id] = pass_helper_slot;
                    end
                else
                    player.target_symbol = "";
                end
            else
                player.haspicked = false;
            end

            player.tooltip = "page://script/apps/Aries/Combat/UI/UnitStatusTip.html?unitid="..index;

            player.char_name = "";
            if(player.nid) then
                if(player.ismob == true) then
                    player.char_name = "NPC:39001("..player.id..")";
                elseif(player.ismob == false) then
                    player.char_name = tostring(player.nid);
                end
            end

            if(player.nid) then
                if(player.max_hp <= 0) then
                    player.max_hp = 1;
                end
                player.hp_text = tostring(player.current_hp).."/"..tostring(player.max_hp).."("..math.ceil(player.current_hp * 100 / player.max_hp).."%)";
                
                player.pips_text = tostring(player.pips).."/14";
            end
            
            if(player.bMinion) then
                player.MinionText = "";
			    local gsItem = ItemManager.GetGlobalStoreItemInMemory(player.nid);
			    if(gsItem) then
				    player.MinionText = gsItem.template.name;
			    end
            else
                player.bMinion = false;
            end
            
            if(player.nid and player.nid < 0) then
                local _followpet = ParaScene.GetCharacter(-player.nid.."+followpet");
                if(_followpet:IsValid()) then
					local att = _followpet:GetAttributeObject();
					player.FollowPetText = att:GetDynamicField("followpet_displayname", "");
                end
            end
            
            -- buff and debuff lines
            local bufftip = "";
            local debufftip = "";
            local buff_set = {};
            local debuff_set = {};
            local MarkSingleBuff = function(descfile, id, desc, positive)
                if(positive == false) then
                    if(debuff_set[descfile]) then
                        if(debuff_set[descfile][id]) then
                            debuff_set[descfile][id].count = debuff_set[descfile][id].count + 1;
                        else
                            debuff_set[descfile][id] = {desc = desc, count = 1};
                        end
                    else
                        debuff_set[descfile] = {
                            [id] = {desc = desc, count = 1}, 
                        };
                    end
                else
                    if(buff_set[descfile]) then
                        if(buff_set[descfile][id]) then
                            buff_set[descfile][id].count = buff_set[descfile][id].count + 1;
                        else
                            buff_set[descfile][id] = {desc = desc, count = 1};
                        end
                    else
                        buff_set[descfile] = {
                            [id] = {desc = desc, count = 1}, 
                        };
                    end
                end
            end
            local buffs = data.slotbuffs[player.slot_id];
            if(buffs) then
		        local charms = ObjectManager.BuffStringToTable(buffs.charms);
		        local wards = ObjectManager.BuffStringToTable(buffs.wards);
		        local overtimes = ObjectManager.BuffStringToTable(buffs.overtimes);
		        local miniaura = buffs.miniaura;
                local miniauras = ObjectManager.BuffStringToTable(miniaura);
                
                local pvp_arena_damage_boost = data.pvp_arena_damage_boost;
                if(type(pvp_arena_damage_boost) == "number") then
                    if(pvp_arena_damage_boost > 0) then
                        MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/PvP_Arena_Damage_Boost_32bits.png;0 0 36 36", "pvp_arena_damage_boost", "攻击力增加"..pvp_arena_damage_boost..[[%]], true);
                    end
                end
                
                local pvp_arena_heal_penalty = data.pvp_arena_heal_penalty;
                if(type(pvp_arena_heal_penalty) == "number") then
                    if(pvp_arena_heal_penalty == 50) then
                        MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/PvP_Arena_Heal_Penalty_32bits.png;0 0 36 36", "pvp_arena_heal_penalty", "治疗效果减少"..pvp_arena_heal_penalty..[[%]], false);
                    end
                end

                local aura = data.aura;
                local aura_gsid_mapping = {
	                ["fire"] = 22106,
	                ["ice"] = 22145,
	                ["storm"] = 22127,
	                ["life"] = 22166,
	                ["death"] = 22187,
	                ["death_damage"] = 22353,
                };
                if(aura) then
                    local aura_gsid = aura_gsid_mapping[aura];
                    if(not aura_gsid) then
                        if(type(aura) == "string") then
				            local _, gsid = string.match(aura, "^([%w_]+)_([%d]+)");
				            if(_ and gsid) then
					            aura_gsid = tonumber(gsid);
				            end
                        end
                    end
                    if(aura_gsid) then
                        local gsItem = ItemManager.GetGlobalStoreItemInMemory(aura_gsid);
                        if(gsItem) then
                            MarkSingleBuff(aura_gsid, aura, gsItem.template.description, if_else(aura == "death", false, true));
                        end
                    end
                end
                
                local aura2 = data.aura2;
                if(aura2 and buff_data.globalauras[aura2]) then
                    local globalaura = buff_data.globalauras[aura2];
                    if(globalaura) then
                        MarkSingleBuff(globalaura.icon_gsid, aura2, globalaura.desc, if_else(globalaura.positive, true, false));
                    end
                end

                local team_auras = data.near_team_auras;
                if(bMyselfFarSideInArena) then
                    team_auras = data.far_team_auras;
                else
                    team_auras = data.near_team_auras;
                end
                local _, team_aura_gsid;
                for _, team_aura_gsid in ipairs(team_auras) do
                    local gsItem = ItemManager.GetGlobalStoreItemInMemory(team_aura_gsid);
                    if(gsItem and gsItem.icon) then
                        local stat_56 = gsItem.template.stats[56];
                        local gsItem = ItemManager.GetGlobalStoreItemInMemory(stat_56);
                        if(gsItem) then
                            MarkSingleBuff(stat_56, stat_56, gsItem.template.description, true);
                        end
                    end
                end

                local _, id;
                for _, id in pairs(charms) do
                    if(id > 0) then
                        local params = buff_data.charms[id];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, id, params.desc, params.positive);
                            end
                        end
                    end
                end
                local _, id;
                for _, id in pairs(wards) do
                    local ward_param = nil;
				    -- remove the param in ward
                    if(type(id) == "string") then
				        local this_id, param = string.match(id, "^([%d]+)_([%d]+)");
				        if(this_id and param) then
					        id = tonumber(this_id);
                            ward_param = tonumber(param);
				        end
                    end
                    if(type(id) ~= "number") then
                        id = 0;
                    end
                    if(id > 0) then
                        local params = buff_data.wards[id];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                local this_desc = params.desc;
                                if(ward_param) then
                                    this_desc = string.gsub(params.desc, "{param}", tostring(ward_param));
                                end
                                MarkSingleBuff(params.icon_gsid, id, this_desc, params.positive);
                            end
                        end
                    end
                end
                local _, id;
                for _, id in pairs(overtimes) do
				    -- remove the rounds and icon_gsid
				    local this_id = string.match(id, "^([^_]+)");
			        local _, rounds, icon_gsid = string.match(id, "^([^_]+)_(%d+)_(%d+)$");
				    if(this_id) then
					    id = this_id;
				    end
                    if(rounds and icon_gsid) then
                        rounds = tonumber(rounds);
                        icon_gsid = tonumber(icon_gsid);
                    end
                    if(icon_gsid and icon_gsid > 0) then
                        local gsItem = ItemManager.GetGlobalStoreItemInMemory(icon_gsid);
                        if(gsItem and gsItem.descfile) then
                            local status_name = gsItem.template.name;
                            local icon = gsItem.descfile;
                            if(id == "fire" or id == "ice" or id == "storm" or id == "myth" or id == "life" or id == "death" or id == "balance") then
                                -- dot attacks
                                status_name = string.format("%s:持续伤害剩余%d回合", status_name, rounds);
                            elseif(id == "hot") then
                                -- hot heals
                                status_name = string.format("%s:持续治疗剩余%d回合", status_name, rounds);
                            elseif(id == "pill") then
                                -- pills
                                local stat_56 = gsItem.template.stats[56];
                                if(stat_56) then
                                    local gsItem = ItemManager.GetGlobalStoreItemInMemory(stat_56);
                                    if(gsItem) then
                                        -- use direct gsid tooltip
                                        icon = stat_56;
                                        status_name = nil;
                                    end
                                end
                            else
                                -- other effects
                                status_name = string.format("%s:剩余%d回合", status_name, rounds);
                            end
                            MarkSingleBuff(icon, ParaGlobal.GenerateUniqueID(), status_name, if_else((id == "hot" or id == "pill"), true, false));
                        end
                    elseif(id == "disabledheal") then
                        -- ward 53: disabled heal
                        local params = buff_data.wards[53];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, 53, params.desc, params.positive);
                            end
                        end
                    elseif(id == "cursedheal") then
                        -- ward 55: cursedheal
                        local params = buff_data.wards[55];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, 55, params.desc, params.positive);
                            end
                        end
                    elseif(id == "cursedpowerpip") then
                        -- ward 56: cursedpowerpip
                        local params = buff_data.wards[56];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, 56, params.desc, params.positive);
                            end
                        end
                    elseif(id == "boostpowerpip") then
                        -- ward 57: boostpowerpip
                        local params = buff_data.wards[57];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, 57, params.desc, params.positive);
                            end
                        end
                    elseif(id == "antifreeze") then
                        -- ward 60: antifreeze
                        local params = buff_data.wards[60];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/AntiFreeze_32bits.png;0 0 36 36", 60, params.desc, params.positive);
                            end
                        end
                    elseif(id == "immunedispel") then
                        -- ward 62: immune to dispel
                        local params = buff_data.wards[62];
                        if(params and params.desc) then
                            MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/ImmuneToDispel_32bits.png;0 0 36 36", 62, params.desc, params.positive);
                        end
                    elseif(id == "immunestun") then
                        -- ward 63: immune to stun
                        local params = buff_data.wards[63];
                        if(params and params.desc) then
                            MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/ImmuneToStun_32bits.png;0 0 36 36", 63, params.desc, params.positive);
                        end
                    elseif(id == "immunefreeze") then
                        -- ward 66: immune to freeze
                        local params = buff_data.wards[66];
                        if(params and params.desc) then
                            MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/ImmuneToFreeze_32bits.png;0 0 36 36", 66, params.desc, params.positive);
                        end
                    elseif(id == "immunekickpet") then
                        local word = "战斗的决心：不会因为其他人进入战斗而主动离开法阵";
                        MarkSingleBuff("Texture/Aries/Combat/UnitBuffs/ImmuneToKickPet_32bits.png;0 0 36 36", 78963, word, true);
                    elseif(id == "firesplash") then
                        -- gsid 22331: Fire_DOTAttackWithSplash_Level6
                        local gsItem = ItemManager.GetGlobalStoreItemInMemory(22331);
                        if(gsItem and gsItem.descfile) then
                            MarkSingleBuff(22331, 0, gsItem.template.name, false);
                        end
                    end
                end
                local i, each_miniaura;
                for i, each_miniaura in pairs(miniauras) do
                    each_miniaura = tonumber(each_miniaura);
                    if(each_miniaura and each_miniaura > 0) then
                        local params = buff_data.miniauras[each_miniaura];
                        if(params and params.icon_gsid and params.desc) then
                            local gsItem = ItemManager.GetGlobalStoreItemInMemory(params.icon_gsid);
                            if(gsItem and gsItem.descfile) then
                                MarkSingleBuff(params.icon_gsid, each_miniaura, params.desc, params.positive);
                            end
                        end
                    end
                end
            end

            local buff_count = 0;
            local debuff_count = 0;

            local buff_set_lines = {};

            local descfile, single_buff_series;
            for descfile, single_buff_series in pairs(buff_set) do
                local id, single_buff;
                for id, single_buff in pairs(single_buff_series) do
                    buff_count = buff_count + 1;
                    table.insert(buff_set_lines, {
                        descfile = descfile,
                        line = buffline(descfile, single_buff.desc, single_buff.count),
                    })
                end
            end
            table.sort(buff_set_lines, function(a, b) return tostring(a.descfile) < tostring(b.descfile); end);
            
            local _, single_buff;
            for _, single_buff in pairs(buff_set_lines) do
                bufftip = bufftip .. single_buff.line;
            end

            local descfile, single_buff_series;
            for descfile, single_buff_series in pairs(debuff_set) do
                local id, single_buff;
                for id, single_buff in pairs(single_buff_series) do
                    debuff_count = debuff_count + 1;
                    debufftip = debufftip .. buffline(descfile, single_buff.desc, single_buff.count);
                end
            end

            player.bufftip = bufftip;
            player.debufftip = debufftip;

            local rows = 0;
            rows = math.ceil(buff_count / 6) + math.ceil(debuff_count / 6);

player.buff_fulltip_block = string.format(
[[<div style="margin-left:95px;margin-top:-%dpx;width:140px;">
    %s
    <br/>
    %s
</div>]], 96 + 21 * (rows - 1), bufftip, debufftip);
            
            if(player.followpet_gsid == nil) then
                player.followpet_gsid = 0;
            end

            if(player.nid) then
                if(player.nid > 0) then
                    local _, each_player;
                    for _, each_player in pairs(data.players) do
                        if(each_player.nid and each_player.nid == -player.nid) then
                            player.followpet_gsid = 0;
                            break;
                        end
                    end
                elseif(player.nid < 0) then
                    local _, each_player;
                    for _, each_player in pairs(data.players) do
                        if(each_player.nid and -each_player.nid == player.nid) then
                            player.followpet_gsid = each_player.followpet_gsid or 0;
                            break;
                        end
                    end
                end
            end
            return player;
        else
            return nil;
        end
    end
end

function getCardTip(templategsid)
    templategsid = tonumber(templategsid);
    if(not templategsid)then 
        LOG.warn("templategsid is nil in HP_Slot_Lower.html");
        return;
    end 
    local s = string.format("page://script/apps/Aries/Inventory/Cards/CardsTooltip.html?gsid=%d&state=4",templategsid);
    return s;
end

function ShowHP(curhp, maxhp)
    local width = math.ceil(curhp / maxhp * 164);

    if(curhp<=0)then
        return "";
    elseif(width < 10) then
        width = 10;
    end

    local s = string.format( [[<img src="Texture/Aries/Combat/CombatStateTeen/hp3_32bits.png; 0 0 %d 16" zorder="11" style="margin-top:-32px;width:%dpx;height:16px;"/>]], width, width );
    if((curhp * 5) < maxhp) then
        s = string.format( [[<img src="Texture/Aries/Combat/CombatStateTeen/hp3_animated_32bits_fps5_a002.png; 0 0 %d 16" zorder="11" style="margin-top:-32px;width:%dpx;height:16px;"/>]], width, width );
    end
    return s;
end

function ShowPips(cur_pips, max_pips)
    local width = math.ceil(cur_pips / max_pips * 96);

    if(cur_pips <= 0)then
        return "";
    elseif(width < 10)then
        width = 10;
    end

    local s = string.format( [[<img src="Texture/Aries/Combat/CombatStateTeen/hp5_32bits.png; 0 0 %d 16" zorder="11" style="margin-top:-32px;width:%dpx;height:16px;"/>]], width, width );
    return s;
end

local _, __, screen_width, ___ = ParaUI.GetUIObject("root"):GetAbsPosition();

separator_width = math.floor((screen_width - 228 * 4) / 5);

OnClickTargetPicker = function ()
    MyCompany.Aries.Combat.MsgHandler.OnClickTargetPicker();
end

OnClickPassFollowPetCombatCard = function ()
    MyCompany.Aries.Combat.MsgHandler.OnClickPassFollowPetCombatCard();
end

]]></script>
<div style="margin-left:0px;margin-top:200px;width:2960px;height:550px;" class="highbluecolor">
 
    <pe:gridview ClickThrough="true" DataSource="<%=DS_Func_Players%>" name="HomelandStoreItemView" style="margin-left:3px;margin-top:-55px;" 
            CellPadding="0"  DefaultNodeHeight = "70" ItemsPerLine="4" AllowPaging="false" pagesize="4">
        <Columns>
            <div style='<%=format("float:left;width:%dpx;height:80px;", Eval("separator_width"))%>' />
            <div style="float:left;margin-left:-2px;width:228px;">
                <pe:if condition='<%=Eval("isEmpty") == true%>'>
                </pe:if>
                <pe:if condition='<%=Eval("isEmpty") == false%>'>
                    <div style="margin-top:100px;width:248px;height:80px;">
                        <input type="button" alwaysmouseover="true" zorder="-1" force_ui_name='<%="hp_slot_frame_"..Eval("nid")%>' style="float:left;position:relative;margin-left:-4px;margin-top:-3px;width:248px;height:98px;background:url(Texture/Aries/Combat/CombatStateTeen/combatState_bg2_32bits.png#0 0 248 98)"/>
                        <div style="position:relative;">
                            <div style="float:left;margin-left:5px;margin-top:8px;width:64px;height:64px;">
                                <pe:if condition='<%=Eval("nid") > 0 and Eval("bMinion") ~= true%>' >
                                    <div zorder="1" style="position:relative;margin-top:16px;margin-left:-15px;background:url()">
                                        <img zorder="11" src='<%=Eval("slot_symbol_small")%>' style="width:32px;height:32px;margin-top:24px;"/>
                                    </div>
                                    <div style="width:64px;height:64px;">
                                        <aries:userhead nid = '<%=Eval("nid")%>' style="margin-left:6px;margin-top:9px;width:54px;height:54px;"/>
                                    </div>
                                </pe:if>
                                <pe:if condition='<%=Eval("nid") > 0 and Eval("bMinion") == true%>' >
                                    <div zorder="1" style="position:relative;margin-top:16px;margin-left:-15px;background:url()">
                                        <img zorder="11" src='<%=Eval("slot_symbol_small")%>' style="width:32px;height:32px;margin-top:24px;"/>
                                    </div>
                                    <div style="width:64px;height:64px;">
                                        <img zorder="10" src='<%=Eval("slot_symbol")%>' style="background-color:#338ba4;width:64px;height:64px;"/>
                                    </div>
                                </pe:if>
                                <pe:if condition='<%=Eval("nid") < 0%>' >
                                    <div zorder="1" style="position:relative;margin-top:16px;margin-left:-15px;background:url()">
                                        <img zorder="11" src='<%=Eval("slot_symbol_small")%>' style="width:32px;height:32px;margin-top:24px;"/>
                                    </div>
                                    <div style="width:64px;height:64px;">
                                        <aries:combatpet zorder="113" enable_tooltip="true" gsid='<%=Eval("followpet_gsid")%>' show_icon="true" use_trans="true" tooltip_is_lock_position="true" tooltip_offset_x="64" style="width:64px;height:64px;" isclickable="false"/>
                                    </div>
                                </pe:if>

                                <pe:if condition='<%=Eval("followpet_gsid") ~= 0 and Eval("nid") > 0%>' >
                                    <div zorder="2" style="margin-left:-16px;margin-top:-64px;width:32px;height:32px;background:url(Texture/Aries/Combat/CombatStateTeen/followpet_frame_32bits.png);">
                                        <aries:combatpet zorder="113" enable_tooltip="true" gsid='<%=Eval("followpet_gsid")%>' show_icon="true" use_trans="true" tooltip_is_lock_position="true" tooltip_offset_x="64" style="margin-left:2px;width:28px;height:28px;" isclickable="false"/>
                                    </div>
                                </pe:if>

                                <!--<pe:if condition='<%=Eval("followpet_gsid") == 0%>' >
                                    <img zorder="10" src='<%=Eval("slot_symbol")%>' style="background-color:#338ba4;width:64px;height:64px;"/>
                                </pe:if>
                                <pe:if condition='<%=Eval("followpet_gsid") ~= 0%>' >
                                    <div zorder="1" style="position:relative;margin-top:16px;margin-left:-15px;background:url()">
                                        <img zorder="11" src='<%=Eval("slot_symbol_small")%>' style="width:32px;height:32px;margin-top:24px;"/>
                                    </div>
                                    <aries:combatpet zorder="113" enable_tooltip="true" gsid='<%=Eval("followpet_gsid")%>' show_icon="true" use_trans="true" tooltip_is_lock_position="true" tooltip_offset_x="64" style="width:64px;height:64px;" isclickable="false"/>
                                </pe:if>-->
                            </div>

                            <div class="highbluecolor" style="float:left;margin-left:28px;margin-top:15px;width:120px;height:22px;font-size:12;text-align:center;">
                                <pe:if condition='<%=Eval("bMinion") == true%>' >
                                    <input type="button" value='<%=Eval("MinionText")%>' zorder="10" style="color:#99ffff;float:left;width:120px;height:22px;font-size:12px;text-align:center;background:;"/>
                                </pe:if>
                                <pe:if condition='<%=Eval("bMinion") ~= true%>' >
                                    <pe:if condition='<%=Eval("nid") == tonumber(System.User.nid)%>' >
                                        <pe:name nid='<%=Eval("nid")%>' style="color:#40dd2a;font-weight:bold" linked="false"/>
                                    </pe:if>
                                    <pe:if condition='<%=Eval("nid") ~= tonumber(System.User.nid)%>' >
                                        <pe:if condition='<%=Eval("nid") >= 0%>' >
                                            <pe:name nid='<%=Eval("nid")%>' linked="false"/>
                                        </pe:if>
                                        <pe:if condition='<%=Eval("nid") < 0%>' >
                                            <input type="button" value='<%=Eval("FollowPetText")%>' zorder="10" style="color:#99ffff;float:left;width:120px;height:22px;font-size:12px;text-align:center;background:;"/>
                                        </pe:if>
                                        
                                    </pe:if>
                                </pe:if>
                            </div>
                        </div>
                        <div style="position:relative;margin-left:70px;margin-top:38px;color:#ff0000;font-size:12px;width:128px;height:16px;">
                            <img src="Texture/Aries/Combat/CombatStateTeen/hp4_32bits.png; 0 0 164 16" zorder="10" style="width:164px;height:16px;margin-bottom:16px;"/>
                            <%=ShowHP(Eval("current_hp"),Eval("max_hp")) %>
                        </div>

                        <input type="button" value='<%=Eval("hp_text")%>' zorder="12" style="position:relative;margin-left:75px;margin-top:35px;width:160px;height:22px;color:#f6f655;font-size:11px;text-align:center;background:;" />

                        <div style="position:relative;margin-left:72px;margin-top:57px;color:#ff0000;font-size:12px;width:100px;height:16px;">
                            <img src="Texture/Aries/Combat/CombatStateTeen/hp6_32bits.png; 0 0 96 16" zorder="10" style="width:96px;height:16px;margin-bottom:16px;"/>
                            <%=ShowPips(Eval("pips"), 14) %>
                        </div>

                        <input type="button" value='<%=Eval("pips_text")%>' zorder="12" style="position:relative;margin-left:45px;margin-top:52px;width:160px;height:22px;color:#f6f3fe;font-size:11px;text-align:center;background:;" />

                        <input type="button" value='<%=tostring(Eval("level"))%>' zorder="12" style="color:#99ffff;float:left;margin-left:58px;margin-top:9px;text-align:center;width:64px;height:32px;font-size:11px;background:;" />

                        <div style="position:relative;margin-left:-47px;margin-top:10px;float:left;width:32px;height:32px;">
                            <img src='<%=Eval("school_symbol")%>' zorder="10" style="margin-left:-21px;margin-top:-1px;width:16px;height:16px;"/>
                        </div>
                    </div>
                    
                    <%=Eval("buff_fulltip_block") %>

                    <div style="position:relative;">
                        <!--<pe:if condition='<%=Eval("bMyArenaPlayingTurns") == false%>'>-->
                        <pe:if condition='<%=Eval("isInTutorial") == false%>'>
                            <div style="margin-left:0px;margin-top:-155px;color:#FF0000;text-shadow:true;width:168px;height:30px;">
                                <pe:if condition='<%=Eval("isAutoAICard") == true%>'>
                                    自动战斗中...
                                </pe:if>
                            </div>
                            <div style="float:left;margin-left:-16px;margin-top:-134px;width:104px;height:56px;">
                            <!--<div style="float:left;margin-left:56px;margin-top:-200px;width:168px;height:88px;background:texture/alphadot.png">-->
                                
                                
                                <pe:if condition='<%=Eval("bMyselfFarSideInArena") == false%>'>
                                    <div style="position:relative;margin-left:4px;margin-top:4px;">
                                        <div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot5")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot6")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot7")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot8")%>
                                        </div>
                                        <br/>
                                        <div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot4")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot3")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot2")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot1")%>
                                        </div>
                                    </div>
                                </pe:if>
                                <pe:if condition='<%=Eval("bMyselfFarSideInArena") == true%>'>
                                    <div style="position:relative;margin-left:4px;margin-top:4px;">
                                        <div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot4")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot3")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot2")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot1")%>
                                        </div>
                                        <br/>
                                        <div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot5")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot6")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot7")%>
                                        </div><div style="float:left;margin:0px;padding:0px;width:24px;height:24px;background:url(Texture/Aries/Common/ThemeTeen/bg_treemenu_32bits.png: 4 4 4 4)">
                                            <%=Eval("pick_card_helper_slot8")%>
                                        </div>
                                    </div>
                                </pe:if>

                            </div>
                        </pe:if>
                        <!--</pe:if>-->
                    </div>
                    <input type="button" name='<%=Eval("char_name")%>' force_ui_name='<%=Eval("char_name")%>' zorder="100" onclick="OnClickTargetPicker" tooltip='<%=Eval("tooltip")%>' is_lock_position="true" use_mouse_offset="false" tooltip_offset_x="-30" tooltip_offset_y="96" screen_padding_bottom="120" style="position:relative;margin-top:-70px;width:240px;height:100px;background:;"/>
                    <pe:if condition='<%=Eval("nid") and Eval("nid") == -tonumber(System.User.nid)%>' >
                        <input type="button" value='跳过' zorder="101" onclick="OnClickPassFollowPetCombatCard"  style="color:#99ffff;float:left;width:48px;height:22px;font-size:12px;text-align:center;margin-left:187px;margin-top:-20px;"/>
                    </pe:if>
                </pe:if>
            </div>
        </Columns>
        <EmptyDataTemplate>
            <b>Empty Items</b>
        </EmptyDataTemplate>
        <FetchingDataTemplate>
            <div style="margin-left:50px;margin-top:26px;color:#FFFFFF">数据加载中，请稍等.....</div>
        </FetchingDataTemplate>
    </pe:gridview>
</div>
</pe:mcml> 
</body>
</html>